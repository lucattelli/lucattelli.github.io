/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Change","sap/ui/fl/Utils","jquery.sap.global","sap/ui/fl/LrepConnector","sap/ui/fl/Cache","sap/ui/fl/context/ContextManager","sap/ui/fl/changeHandler/JsControlTreeModifier"],function(C,U,$,L,a,b,J){"use strict";var c=function(s,l){this._sComponentName=s;this._mChanges={};if(!this._sComponentName){U.log.error("The Control does not belong to a SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._oConnector=l||this._createLrepConnector();this._aDirtyChanges=[];};c.prototype.getComponentName=function(){return this._sComponentName;};c.prototype._createLrepConnector=function(){return L.createConnector();};c.prototype.getCacheKey=function(){return a.getChangesFillingCache(this._oConnector,this._sComponentName,undefined).then(function(w){return w.etag;});};c.prototype._preconditionsFulfilled=function(A,o){if(o.fileType!=="change"){return false;}if(o.changeType==="defaultVariant"){return false;}if(o.changeType!=="codeExt"&&(!o.selector||!o.selector.id)){return false;}if(!b.doesContextMatch(o,A)){return false;}return true;};c.prototype.getChangesForComponent=function(p){var t=this;return a.getChangesFillingCache(this._oConnector,this._sComponentName,p).then(function(w){t._bHasLoadedChangesFromBackend=true;if(!w.changes||!w.changes.changes){return[];}var e=w.changes.changes;var f=w.changes.contexts||[];return new Promise(function(r){b.getActiveContexts(f).then(function(A){r(e.filter(t._preconditionsFulfilled.bind(t,A)).map(d));});});});function d(o){return new C(o);}};c.prototype._addChangeIntoMap=function(o,d){var s=d.getSelector();if(s&&s.id){var S=s.id;if(s.idIsLocal){S=o.createId(S);}if(!this._mChanges[S]){this._mChanges[S]=[];}this._mChanges[S].push(d);}return this._mChanges;};c.prototype.loadChangesMapForComponent=function(o,p){var t=this;return this.getChangesForComponent(p).then(d);function d(e){e.forEach(function(f){t._addChangeIntoMap(o,f);});return t.getChangesMapForComponent.bind(t);}};c.prototype.getChangesMapForComponent=function(){return this._mChanges;};c.prototype.getChangesForView=function(v,p){var t=this;return this.getChangesForComponent(p).then(function(e){return e.filter(d.bind(t));});function d(o){var s=o.getSelector().id;if(!s||!p){return false;}var S=s.slice(0,s.lastIndexOf("--"));var v;if(o.getSelector().idIsLocal){var A=p.appComponent;if(A){v=A.getLocalId(p.viewId);}}else{v=p.viewId;}return S===v;}};c.prototype.addChange=function(v,o){var n;if(v instanceof C){n=v;}else{n=new C(v);}this._aDirtyChanges.push(n);this._addChangeIntoMap(o,n);return n;};c.prototype.saveDirtyChanges=function(){var d=this._aDirtyChanges.slice(0);var D=this._aDirtyChanges;var r=this._getRequests(d);var p=this._getPendingActions(d);if(p.length===1&&r.length===1&&p[0]==="NEW"){var R=r[0];var P=this._prepareDirtyChanges(D);return this._oConnector.create(P,R).then(this._massUpdateCacheAndDirtyState(D,d));}else{return d.reduce(function(s,o){var e=s.then(this._performSingleSaveAction(o).bind(this));e.then(this._updateCacheAndDirtyState(D,o));return e;}.bind(this),Promise.resolve());}};c.prototype._performSingleSaveAction=function(d){return function(){if(d.getPendingAction()==="NEW"){return this._oConnector.create(d.getDefinition(),d.getRequest());}if(d.getPendingAction()==="DELETE"){return this._oConnector.deleteChange({sChangeName:d.getId(),sLayer:d.getLayer(),sNamespace:d.getNamespace(),sChangelist:d.getRequest()});}};};c.prototype._updateCacheAndDirtyState=function(d,D){var t=this;return function(){if(D.getPendingAction()==="NEW"){a.addChange(t._sComponentName,D.getDefinition());}if(D.getPendingAction()==="DELETE"){a.deleteChange(t._sComponentName,D.getDefinition());}var i=d.indexOf(D);if(i>-1){d.splice(i,1);}};};c.prototype._massUpdateCacheAndDirtyState=function(d,D){var t=this;jQuery.each(D,function(i,o){t._updateCacheAndDirtyState(d,o)();});};c.prototype._getRequests=function(d){var r=[];jQuery.each(d,function(i,o){var R=o.getRequest();if(r.indexOf(R)===-1){r.push(R);}});return r;};c.prototype._getPendingActions=function(d){var p=[];jQuery.each(d,function(i,o){var P=o.getPendingAction();if(p.indexOf(P)===-1){p.push(P);}});return p;};c.prototype._prepareDirtyChanges=function(d){var e=[];jQuery.each(d,function(i,o){e.push(o.getDefinition());});return e;};c.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};c.prototype.deleteChange=function(o){var i=this._aDirtyChanges.indexOf(o);if(i>-1){if(o.getPendingAction()==="DELETE"){return;}this._aDirtyChanges.splice(i,1);return;}o.markForDeletion();this._aDirtyChanges.push(o);};return c;},true);
