/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./TableExtension','sap/ui/core/delegate/ItemNavigation','./TableUtils','./TableKeyboardDelegate2','./TableKeyboardDelegate'],function(q,T,I,a,N,O){"use strict";var k=q.sap.getUriParameters().get('sap-ui-xx-table-oldkeyboard');var l=k==="true"||k==="TRUE"||k==="x"||k==="X";var b={_forward:function(t,e){var i=t._getItemNavigation();if(i&&!t._getKeyboardExtension()._itemNavigationSuspended&&!e.isMarked("sapUiTableSkipItemNavigation")){i["on"+e.type](e);}},onfocusin:function(e){b._forward(this,e);},onsapfocusleave:function(e){b._forward(this,e);},onmousedown:function(e){b._forward(this,e);},onsapnext:function(e){b._forward(this,e);},onsapnextmodifiers:function(e){b._forward(this,e);},onsapprevious:function(e){b._forward(this,e);},onsappreviousmodifiers:function(e){b._forward(this,e);},onsappageup:function(e){b._forward(this,e);},onsappagedown:function(e){b._forward(this,e);},onsaphome:function(e){b._forward(this,e);},onsaphomemodifiers:function(e){b._forward(this,e);},onsapend:function(e){b._forward(this,e);},onsapendmodifiers:function(e){b._forward(this,e);},onsapkeyup:function(e){b._forward(this,e);}};var E={onfocusin:function(e){var o=this._getKeyboardExtension();if(!o._bIgnoreFocusIn){o.initItemNavigation();if(c.isItemNavigationInvalid(this)){e.setMarked("sapUiTableInitItemNavigation");}}else{e.setMarked("sapUiTableIgnoreFocusIn");}if(e.target&&e.target.id===this.getId()+"-rsz"){e.preventDefault();e.setMarked("sapUiTableSkipItemNavigation");}}};var c={_initItemNavigation:function(e){var t=e.getTable();var $=t.$();var C=a.getVisibleColumnCount(t);var f=C;var h=a.hasRowHeader(t);var g=[];if(t.getFixedColumnCount()==0){g=$.find(".sapUiTableCtrl:not(.sapUiTableCHT) td[tabindex]").get();}else{var j=$.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)');var m=$.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)');var n=$.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)');var o=$.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)');var p=$.find('.sapUiTableCtrlFixed.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)');var r=$.find('.sapUiTableCtrlScroll.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)');for(var i=0;i<t.getVisibleRowCount();i++){g=g.concat(j.find('tr[data-sap-ui-rowindex="'+i+'"]').find('td[tabindex]').get());g=g.concat(m.find('tr[data-sap-ui-rowindex="'+i+'"]').find('td[tabindex]').get());g=g.concat(n.find('tr[data-sap-ui-rowindex="'+i+'"]').find('td[tabindex]').get());g=g.concat(o.find('tr[data-sap-ui-rowindex="'+i+'"]').find('td[tabindex]').get());g=g.concat(p.find('tr[data-sap-ui-rowindex="'+i+'"]').find('td[tabindex]').get());g=g.concat(r.find('tr[data-sap-ui-rowindex="'+i+'"]').find('td[tabindex]').get());}}var s=g.length;if(h){var R=$.find(".sapUiTableRowHdr").get();for(var i=R.length-1;i>=0;i--){g.splice(i*C,0,R[i]);s++;}s--;f++;}if(t.getColumnHeaderVisible()){var H=[];var F=$.find(".sapUiTableCHT.sapUiTableCtrlFixed>tbody>tr");var S=$.find(".sapUiTableCHT.sapUiTableCtrlScroll>tbody>tr");for(var i=0;i<a.getHeaderRowCount(t);i++){if(h){H.push(t.getDomRef("selall"));}if(F.length){H=H.concat(q(F.get(i)).find(".sapUiTableCol").get());}if(S.length){H=H.concat(q(S.get(i)).find(".sapUiTableCol").get());}}g=H.concat(g);}if(!e._itemNavigation){e._itemNavigation=new I();e._itemNavigation.setTableMode(true);e._itemNavigation.attachEvent(I.Events.AfterFocus,function(u){var v=a.getFocusedItemInfo(t);v.header=a.getHeaderRowCount(t);v.domRef=null;if(v.row>=v.header){e._oLastFocusedCellInfo=v;}},t);}e._itemNavigation.setColumns(f);e._itemNavigation.setRootDomRef($.find(".sapUiTableCnt").get(0));e._itemNavigation.setItemDomRefs(g);e._itemNavigation.setFocusedIndex(c.getInitialItemNavigationIndex(e));e._itemNavigationInvalidated=false;},getInitialItemNavigationIndex:function(e){return a.hasRowHeader(e.getTable())?1:0;},isItemNavigationInvalid:function(e){return!e._itemNavigation||e._itemNavigationInvalidated;}};var d=T.extend("sap.ui.table.TableKeyboardExtension",{_init:function(t,s,S){this._itemNavigation=null;this._itemNavigationInvalidated=false;this._itemNavigationSuspended=false;this._type=s;this._legacy=l;var e=N;if(l){q.sap.log.warning("The old keyboard handling of sap.ui.table.Table is deprecated and will be deactivated soon.");e=O;}this._delegate=new e(s);this._actionMode=false;t.addEventDelegate(E,t);t.addEventDelegate(this._delegate,t);t.addEventDelegate(b,t);t._getItemNavigation=function(){return this._itemNavigation;}.bind(this);return"KeyboardExtension";},_debug:function(){this._ExtensionHelper=c;this._ItemNavigationDelegate=b;this._ExtensionDelegate=E;},destroy:function(){var t=this.getTable();if(t){t.removeEventDelegate(E);t.removeEventDelegate(this._delegate);t.removeEventDelegate(b);}if(this._itemNavigation){this._itemNavigation.destroy();this._itemNavigation=null;}if(this._delegate){this._delegate.destroy();this._delegate=null;}T.prototype.destroy.apply(this,arguments);}});d.prototype.initItemNavigation=function(){if(c.isItemNavigationInvalid(this)){c._initItemNavigation(this);}};d.prototype.invalidateItemNavigation=function(){this._itemNavigationInvalidated=true;};d.prototype.setActionMode=function(e){if(e===true&&!this._actionMode&&this._delegate.enterActionMode){this._actionMode=this._delegate.enterActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))===true;}else if(e===false&&this._actionMode&&this._delegate.leaveActionMode){this._actionMode=false;this._delegate.leaveActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1));}};d.prototype.isInActionMode=function(){return this._actionMode;};d.prototype.updateNoDataAndOverlayFocus=function(p){var t=this.getTable();if(!t||!t.getDomRef()){return;}if(t.getShowOverlay()){if(q.sap.containsOrEquals(t.getDomRef(),p)){t.$("overlay").focus();}}else if(a.isNoDataVisible(t)){if(q.sap.containsOrEquals(t.getDomRef("sapUiTableCnt"),p)){t.$("noDataCnt").focus();}}else if(q.sap.containsOrEquals(t.getDomRef("noDataCnt"),p)||q.sap.containsOrEquals(t.getDomRef("overlay"),p)){a.focusItem(t,c.getInitialItemNavigationIndex(this));}};d.prototype._suspendItemNavigation=function(){this._itemNavigationSuspended=true;};d.prototype._resumeItemNavigation=function(){this._itemNavigationSuspended=false;};d.prototype._isItemNavigationSuspended=function(){return this._itemNavigationSuspended;};d.prototype._getLastFocusedCellInfo=function(){var h=a.getHeaderRowCount(this.getTable());if(!this._oLastFocusedCellInfo||this._oLastFocusedCellInfo.header!=h){var i=a.getFocusedItemInfo(this.getTable());var D=c.getInitialItemNavigationIndex(this);return{cellInRow:D,row:h,header:h,cellCount:i.cellCount,columnCount:i.columnCount,cell:i.columnCount*h+D};}return this._oLastFocusedCellInfo;};d.prototype._setSilentFocus=function(e){this._bIgnoreFocusIn=true;this._setFocus(e);this._bIgnoreFocusIn=false;};d.prototype._setFocus=function(e){if(!e){return;}var t=this.getTable();var C=a.getCellInfo(e)||{};if(C.type&&t){var $=q(e);if($.attr("tabindex")!="0"){var o=t._getItemNavigation();if(o&&o.aItemDomRefs){for(var i=0;i<o.aItemDomRefs.length;i++){if(o.aItemDomRefs[i]){o.aItemDomRefs[i].setAttribute("tabindex","-1");}}}$.attr("tabindex","0");}}e.focus();};d.prototype._getTableType=function(){return this._type;};return d;},true);
